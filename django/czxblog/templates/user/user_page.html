{% extends 'base.html' %}

{% block title %}
    <title>夕象^登录</title>
{% endblock title %}

<html lang="en">


<body>
    {% block user %}
	<div class="container">
		<div class="head_text">
			<h1 class="text-info">欢迎登录</h1>
			<small>让我们一起分享你的知识、经验和见解</small>
		</div>
		<form id="user_form" class="main_form" method='post'>
			<input id="reback_url" type="hidden" value="{{reback_url}}">
			<div id="user_control">
				<div class="control-group">
					<label class="control-label" for="user_name">邮箱：</label>
					<input type="text" id="user_name" class="input-xlarge" name="user_name" placeholder="请输入邮箱" autocomplete="off">
				</div>
				<div class="control-group">
					<label class="control-label" for="user_pwd">密码：</label>
					<input type="password" id="user_pwd" class="input-xlarge" name="user_pwd" placeholder="请输入密码" autocomplete="off">
				</div>
			</div>

            <div class="account_list">
				<span class="other_account">第三方账号登录：</span>
				<a href="/oauth/qq_login?state={{reback_url}}" title="QQ登录">
					<img src="/static/images/logo/logo_qq.png" alt="QQ登录">
				</a>
				<a href="/oauth/sina_login?state={{reback_url}}" title="微博登录">
					<img src="/static/images/logo/logo_sina.png" alt="微博登录">
				</a>
				<a href="/oauth/github_login?state={{reback_url}}" title="Github登录">
					<img src="/static/images/logo/logo_github.png" alt="Github登录">
				</a>
			</div>

			<p id="tip_text" style="color:red;"></p>
			<div class="form_buttons">
				<p>我是老用户：</p>
				<input type="submit" class="btn btn-primary" value="登录"/>
				<a class="btn btn-default" href="{% url 'password_lost' %}">忘记密码</a>
			</div>
			<div class="form_buttons" style="margin-left:1.5em;">
				<p>我是新用户：</p>
				<input id="user_register" type="button" class="btn btn-primary" value="注册"/>
			</div>
		</form>
	</div>
	{% endblock user %}

	<!--登录注册页面样式-->
    <style type="text/css">
        .head_text{
            text-align: center;
            margin: 2em auto;
        }
        .main_form{
            margin: 0 auto;
            width: 300px;
            border: 2px #aaa dashed;
            padding: 1.5em 0em 0em 1.5em;
        }
        .main_form a{
            text-decoration: none;
        }
        .other_account{
            font-weight: bolder;
        }
        .account_list{
            margin-top: 0.5em;
        }
        .form_buttons{
            margin-top: 2em;
            float: left;
        }
    </style>
    <!--前端登录注册ajax请求-->
    <script type="text/javascript">
        $(function(){
            //登录
            $('#user_form').submit(function(){
                //验证
                var tip=$('#tip_text');
                tip.text('');

                if($('#user_name').val()==''){
                    tip.text('请输入邮箱');
                    return false;
                };
                if($('#user_pwd').val()==''){
                    tip.text('请输入密码');
                    return false;
                };

                //登录
                $.ajax({
                    type: "POST",
                    data: $('#user_form').serialize(), //$.param(data),
                    url: "{% url 'user_login' %}",
                    cache: false,
                    dataType: "json",
                    success: function(json, textStatus){
                        var is_success = json['success'];
                        if(is_success){
                            tip.text('登录成功，页面处理中...');

                            //跳转回原来的页面
                            var reback_url = $('#reback_url').val();
                            if(!reback_url){reback_url='/';}
                            window.location.href = reback_url;
                        }else{
                            tip.text('邮箱或者密码错误，请重试');
                        };
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        tip.text("登录出错，请重试 "+errorThrown);
                    }
                });
                return false;
            });

            //注册
            $('#user_register').click(function(){
                //验证
                var tip=$('#tip_text');
                tip.text('');

                var reg_name=$('#user_name').val();
                var reg_pwd=$('#user_pwd').val();

                if(reg_name==''){
                    tip.text('邮箱不能为空');
                    return false;
                };
                if(!reg_name.match(/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/)){
                    tip.text('请输入正确的邮箱格式');
                    return false;
                }

                if(reg_pwd==''){
                    tip.text('密码不能为空');
                    return false    ;
                };
                if(reg_pwd.length<6){
                    tip.text('密码不能少于6位');
                }

                //注册
                tip.text('注册中，请稍后...');
                $.ajax({
                    type: "POST",
                    data:$('#user_form').serialize(), // $.param(data),
                    url: "{% url 'user_register' %}",
                    cache: false,
                    dataType: "json",
                    success: function(json, textStatus){
                        var is_success = json['success'];
                        if(is_success){
                            tip.text('注册成功，页面处理中...');
                            $('#user_control').text(json['message']);

                            window.setTimeout(function(){
                                var reback_url = $('#reback_url').val();
                                if(!reback_url){reback_url='/';}
                                window.location.href = reback_url;
                            },3000);
                        }else{
                            tip.text(json['message']);
                        };
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        tip.text("注册出错，请重试 "+errorThrown);
                    }
                });
                return false;
            });
        });
    </script>

</body>

</html>
